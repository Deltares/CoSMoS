<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cosmos.cosmos_webviewer &mdash; CoSMoS 0.1 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CoSMoS
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">User manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Functions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CoSMoS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cosmos.cosmos_webviewer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cosmos.cosmos_webviewer</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon May 10 14:28:48 2021</span>

<span class="sd">@author: ormondt</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">geojson</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">FeatureCollection</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">Transformer</span>

<span class="kn">from</span> <span class="nn">.cosmos_main</span> <span class="kn">import</span> <span class="n">cosmos</span>
<span class="kn">from</span> <span class="nn">.cosmos_timeseries</span> <span class="kn">import</span> <span class="n">merge_timeseries</span> <span class="k">as</span> <span class="n">merge</span>
<span class="kn">from</span> <span class="nn">.cosmos_tiling</span> <span class="kn">import</span> <span class="n">make_wave_map_tiles</span>
<span class="kn">from</span> <span class="nn">.cosmos_tiling</span> <span class="kn">import</span> <span class="n">make_precipitation_tiles</span>

<span class="kn">import</span> <span class="nn">cht.misc.fileops</span> <span class="k">as</span> <span class="nn">fo</span>
<span class="kn">import</span> <span class="nn">cht.misc.misc_tools</span>

<div class="viewcode-block" id="WebViewer"><a class="viewcode-back" href="../../_generated/cosmos.cosmos_webviewer.WebViewer.html#cosmos.cosmos_webviewer.WebViewer">[docs]</a><span class="k">class</span> <span class="nc">WebViewer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cosmos webviewer class</span>
<span class="sd">    &quot;&quot;&quot;</span>    

<div class="viewcode-block" id="WebViewer.__init__"><a class="viewcode-back" href="../../_generated/cosmos.cosmos_webviewer.WebViewer.html#cosmos.cosmos_webviewer.WebViewer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize webviewer. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of webviewer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span>    <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span>    <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span> <span class="s2">&quot;webviewers&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">webviewer_version</span>
        <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span></div>
    
    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make webviewer. </span>
<span class="sd">        - Makes local copy of the webviewer from a template. If such a copy already exists, data will be copied to the existing webviewer.</span>
<span class="sd">        - Updating the scenario.js with the current scenario.</span>
<span class="sd">        - Make a variable file defining the variables that are mapped for the current scenario.</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c1"># Makes local copy of the web viewer</span>
        <span class="c1"># If such a copy already exists, data will be copied to the existing web viewer</span>

        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting web viewer &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check whether web viewer already exists</span>
        <span class="c1"># If not, copy empty web viewer from templates</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            
            <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Making new web viewer from &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="s2">&quot; ...&quot;</span><span class="p">)</span>

            <span class="n">fo</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span>
                                         <span class="s2">&quot;templates&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;webviewers&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                                         <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># Change the title string in index.html to the scenario long name</span>
            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">findreplace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">),</span>
                                       <span class="s2">&quot;COSMOS_VIEWER&quot;</span><span class="p">,</span>
                                       <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">long_name</span><span class="p">)</span>

        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Updating scenario.js ...&quot;</span><span class="p">)</span>

        <span class="c1"># Check if there is a scenarios.js file</span>
        <span class="c1"># If so, append it with the current scenario</span>
        <span class="n">sc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;scenarios.js&quot;</span><span class="p">)</span>
        <span class="n">update_scenarios_js</span><span class="p">(</span><span class="n">sc_file</span><span class="p">)</span>
        
        <span class="c1"># Make scenario folder in web viewer</span>
        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Removing old scenario folder from web viewer ...&quot;</span><span class="p">)</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">))</span>
        
        <span class="c1"># Map variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span> <span class="o">=</span> <span class="p">[]</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_timeseries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_floodmap</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_wave_maps</span><span class="p">()</span>
        <span class="c1"># self.copy_sederomap()</span>
        <span class="c1"># self.copy_bedlevelmaps()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_runup_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_meteo_maps</span><span class="p">()</span>
        <span class="n">mv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span>
                               <span class="s2">&quot;variables.js&quot;</span><span class="p">)</span>
        
        <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">mv_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="p">,</span> <span class="s2">&quot;var map_variables =&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">copy_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy available wave, water level, and runup timeseries to webviewer folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Stations and buoys</span>
        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Copying time series ...&quot;</span><span class="p">)</span>
                
        <span class="n">fo</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span> <span class="s2">&quot;timeseries&quot;</span><span class="p">))</span>
        
        <span class="c1"># Set stations to upload (only upload for high-res nested models)</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            
            <span class="n">all_nested_models</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_nested_models</span><span class="p">(</span><span class="s2">&quot;flow&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;beware&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">upload</span> <span class="o">=</span> <span class="kc">False</span> 

            <span class="k">if</span> <span class="n">all_nested_models</span><span class="p">:</span>
                <span class="n">all_nested_stations</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">all_nested_models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beware&#39;</span><span class="p">:</span>
                    <span class="n">all_nested_models</span><span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
                    <span class="n">bw</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bw</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">mdl</span> <span class="ow">in</span> <span class="n">all_nested_models</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">mdl</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                        <span class="n">all_nested_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;tide_gauge&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">all_nested_stations</span> <span class="ow">and</span> <span class="n">bw</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>                            
                            <span class="n">station</span><span class="o">.</span><span class="n">upload</span> <span class="o">=</span> <span class="kc">False</span> 
    
            <span class="n">all_nested_models</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_nested_models</span><span class="p">(</span><span class="s2">&quot;wave&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_nested_models</span><span class="p">:</span>
                <span class="n">all_nested_stations</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">all_nested_models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beware&#39;</span><span class="p">:</span>
                    <span class="n">all_nested_models</span><span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
                    <span class="n">bw</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bw</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">mdl</span> <span class="ow">in</span> <span class="n">all_nested_models</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">mdl</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                        <span class="n">all_nested_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;wave_buoy&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">all_nested_stations</span> <span class="ow">and</span> <span class="n">bw</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">station</span><span class="o">.</span><span class="n">upload</span> <span class="o">=</span> <span class="kc">False</span> 
        
        <span class="c1"># Tide stations</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">flow</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;tide_gauge&quot;</span> <span class="ow">and</span> <span class="n">station</span><span class="o">.</span><span class="n">upload</span><span class="p">:</span>
                        
                        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">station</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">station</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                        
                        <span class="c1"># Check if there is a file in the observations that matches this station</span>
                        <span class="n">obs_file</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">observations_path</span> <span class="ow">and</span> <span class="n">station</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                            <span class="n">obs_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span>
                                               <span class="s2">&quot;observations&quot;</span><span class="p">,</span>
                                               <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">observations_path</span><span class="p">,</span>
                                               <span class="s2">&quot;water_levels&quot;</span><span class="p">)</span>                        
                            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;waterlevel.&quot;</span> <span class="o">+</span> <span class="n">station</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;.observed.csv.js&quot;</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obs_pth</span><span class="p">,</span> <span class="n">fname</span><span class="p">)):</span>
                                <span class="n">obs_file</span> <span class="o">=</span> <span class="n">fname</span>
                                                                        
                        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">station</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                            <span class="s2">&quot;mllw&quot;</span><span class="p">:</span><span class="n">station</span><span class="o">.</span><span class="n">mllw</span><span class="p">,</span>
                                                            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;model_type&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                                            <span class="s2">&quot;cycle&quot;</span><span class="p">:</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_string</span><span class="p">,</span>
                                                            <span class="s2">&quot;obs_file&quot;</span><span class="p">:</span><span class="n">obs_file</span><span class="p">,</span>
                                                            <span class="s2">&quot;obs_folder&quot;</span><span class="p">:</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">observations_path</span><span class="p">}))</span>
                        
                        <span class="c1"># Merge time series from previous cycles</span>
                        <span class="c1"># Go two days back</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">timeseries_path</span>
<span class="c1">#                        path = model.archive_path</span>
                        <span class="n">t0</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">48</span><span class="p">)</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span>
                        <span class="n">v</span>  <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                   <span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                   <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                   <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;waterlevel&#39;</span><span class="p">)</span>
                        
                        <span class="c1"># Check if merge returned values</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                            
                            <span class="c1"># Here we correct for NAVD88 to MSL !!!</span>
                            <span class="n">v</span> <span class="o">+=</span> <span class="n">model</span><span class="o">.</span><span class="n">vertical_reference_level_difference_with_msl</span>                            
                            <span class="n">csv_file</span> <span class="o">=</span> <span class="s2">&quot;waterlevel.&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv.js&quot;</span>
                            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span>
                                                    <span class="s2">&quot;timeseries&quot;</span><span class="p">,</span>
                                                    <span class="n">csv_file</span><span class="p">)</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">,</span>
                                         <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span>
                                         <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>                             
                            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_csv_js</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;var csv = `date_time,wl&#39;</span><span class="p">)</span>
        
        <span class="c1"># Save stations geojson file</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">stations_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span>
                                    <span class="s2">&quot;stations.geojson.js&quot;</span><span class="p">)</span>
            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">stations_file</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var stations =&quot;</span><span class="p">)</span>
                        

        <span class="c1"># Wave buoys</span>
    
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">wave</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;wave_buoy&quot;</span> <span class="ow">and</span> <span class="n">station</span><span class="o">.</span><span class="n">upload</span><span class="p">:</span>                
                        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">station</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">ndbc_id</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">long_name</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">station</span><span class="o">.</span><span class="n">ndbc_id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">long_name</span>

                        <span class="c1"># Check if there is a file in the observations that matches this station</span>
                        <span class="n">obs_file</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">observations_path</span> <span class="ow">and</span> <span class="n">station</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                            <span class="n">obs_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span>
                                               <span class="s2">&quot;observations&quot;</span><span class="p">,</span>
                                               <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">observations_path</span><span class="p">,</span>
                                               <span class="s2">&quot;waves&quot;</span><span class="p">)</span>                        
                            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;waves.&quot;</span> <span class="o">+</span> <span class="n">station</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;.observed.csv.js&quot;</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obs_pth</span><span class="p">,</span> <span class="n">fname</span><span class="p">)):</span>
                                <span class="n">obs_file</span> <span class="o">=</span> <span class="n">fname</span>

                        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">station</span><span class="o">.</span><span class="n">ndbc_id</span><span class="p">,</span>
                                                            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;model_type&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                                            <span class="s2">&quot;cycle&quot;</span><span class="p">:</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_string</span><span class="p">,</span>
                                                             <span class="s2">&quot;obs_file&quot;</span><span class="p">:</span><span class="n">obs_file</span><span class="p">,</span>
                                                             <span class="s2">&quot;obs_folder&quot;</span><span class="p">:</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">observations_path</span><span class="p">}))</span>
    
                        <span class="n">path</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">timeseries_path</span>
                        <span class="n">t0</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">48</span><span class="p">)</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span>
                        
                        <span class="c1"># Hm0</span>
                        <span class="n">v</span>  <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                   <span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                   <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                   <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;waves&#39;</span><span class="p">)</span>
                        
                        <span class="c1"># Check if merge returned values</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                            
                            <span class="c1"># Write csv js file</span>
                            <span class="n">csv_file</span> <span class="o">=</span> <span class="s2">&quot;waves.&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv.js&quot;</span>
                            <span class="n">csv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span>
                                                    <span class="s2">&quot;timeseries&quot;</span><span class="p">,</span>
                                                    <span class="n">csv_file</span><span class="p">)</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">,</span>
                                         <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span>
                                         <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
                            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_csv_js</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;var csv = `date_time,hm0,tp&quot;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">buoys_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span>
                                    <span class="s2">&quot;wavebuoys.geojson.js&quot;</span><span class="p">)</span>
            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">buoys_file</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var buoys =&quot;</span><span class="p">)</span>
        
        <span class="c1"># # Extreme runup height</span>
        <span class="c1"># for model in cosmos.scenario.model:</span>
        <span class="c1">#     if model.type == &#39;beware&#39;:</span>
        <span class="c1">#         model.domain.read_data(os.path.join(model.cycle_output_path,</span>
        <span class="c1">#                                             &quot;BW_output.nc&quot;))                </span>
        <span class="c1">#         model.domain.write_to_geojson(scenario_path, cosmos.scenario.name)</span>
        <span class="c1">#         model.domain.write_to_csv(scenario_path, cosmos.scenario.name)</span>

    <span class="k">def</span> <span class="nf">copy_floodmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy available flood map tiles to webviewer folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Copying flood map tiles ...&quot;</span><span class="p">)</span>

        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Flood maps</span>
        
        <span class="c1"># Check if flood maps are available</span>
        <span class="n">flood_map_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">cycle_tiles_path</span><span class="p">,</span>
                                      <span class="s2">&quot;flood_map&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">flood_map_path</span><span class="p">):</span>
            
            <span class="c1"># 24 hour increments  </span>
            <span class="n">dtinc</span> <span class="o">=</span> <span class="mi">24</span>
    
            <span class="c1"># Wave map for the entire simulation</span>
            <span class="n">dt</span>  <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">dtinc</span><span class="p">)</span>
            <span class="n">t0</span>  <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>    
            <span class="n">t1</span>  <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">stop_time</span>

            <span class="n">pathstr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># 24-hour increments</span>
            <span class="n">requested_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">t0</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span>
                                            <span class="n">end</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span>
                                            <span class="n">freq</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dtinc</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">requested_times</span><span class="p">):</span>
                <span class="n">pathstr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">))</span>
                <span class="n">namestr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; UTC&quot;</span><span class="p">)</span>

            <span class="n">pathstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;combined_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">))</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="n">hrstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mi">3600</span><span class="p">))</span>
            <span class="n">namestr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Combined &quot;</span> <span class="o">+</span> <span class="n">hrstr</span> <span class="o">+</span> <span class="s2">&quot;-hour forecast&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flood_map_path</span><span class="p">,</span> <span class="s2">&quot;combined_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_95&quot;</span><span class="p">)):</span>
                <span class="n">pathstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;combined_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_95&quot;</span><span class="p">)</span>
                <span class="n">namestr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Combined &quot;</span> <span class="o">+</span> <span class="n">hrstr</span> <span class="o">+</span> <span class="s2">&quot;-hour forecast 95 %&quot;</span><span class="p">)</span>

            <span class="n">wvpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">flood_map_path</span><span class="p">,</span> <span class="n">wvpath</span><span class="p">)</span>
            <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;flood_map&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Flood map&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;This is a flood map. It can tell if you will drown.&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;xyz_tile_layer&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;max_native_zoom&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">13</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>


            <span class="n">tms</span> <span class="o">=</span> <span class="p">[]</span>            
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">pth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathstr</span><span class="p">):</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tm</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pth</span>
                <span class="n">tm</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namestr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                <span class="n">tms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">tms</span>  

            <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;flood_map&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>    
            
            <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>

            <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>

            <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
    
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_wave_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy available wave map tiles to webviewer folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="c1"># Wave maps</span>
        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># 24 hour increments  </span>
        <span class="n">dtinc</span> <span class="o">=</span> <span class="mi">24</span>

        <span class="c1"># Wave map for the entire simulation</span>
        <span class="n">dt</span>  <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">dtinc</span><span class="p">)</span>
        <span class="n">t0</span>  <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>    
        <span class="n">t1</span>  <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">stop_time</span>
        
        <span class="n">okay</span>  <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s2">&quot;hurrywave&quot;</span><span class="p">:</span>
                <span class="n">index_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;tiling&quot;</span><span class="p">,</span> <span class="s2">&quot;indices&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">make_wave_map</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">index_path</span><span class="p">):</span>            
                    <span class="n">okay</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">okay</span><span class="p">:</span>
            
            <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Copying wave map tiles ...&quot;</span><span class="p">)</span>
            
            <span class="n">pathstr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># 6-hour increments</span>
            <span class="n">requested_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">t0</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span>
                                            <span class="n">end</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span>
                                            <span class="n">freq</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dtinc</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">requested_times</span><span class="p">):</span>
                <span class="n">pathstr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">))</span>
                <span class="n">namestr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; UTC&quot;</span><span class="p">)</span>

            <span class="n">pathstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;combined_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">))</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="n">hrstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mi">3600</span><span class="p">))</span>
            <span class="n">namestr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Combined &quot;</span> <span class="o">+</span> <span class="n">hrstr</span> <span class="o">+</span> <span class="s2">&quot;-hour forecast&quot;</span><span class="p">)</span>

            <span class="c1"># Check if wave maps are available</span>
            <span class="n">wave_map_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">cycle_tiles_path</span><span class="p">,</span>
                                          <span class="s2">&quot;hm0&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wave_map_path</span><span class="p">,</span> <span class="s2">&quot;combined_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_95&quot;</span><span class="p">)):</span>
                <span class="n">pathstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;combined_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%HZ&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_95&quot;</span><span class="p">)</span>
                <span class="n">namestr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Combined &quot;</span> <span class="o">+</span> <span class="n">hrstr</span> <span class="o">+</span> <span class="s2">&quot;-hour forecast 95 %&quot;</span><span class="p">)</span>          

            
            <span class="n">wvpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">wave_map_path</span><span class="p">,</span> <span class="n">wvpath</span><span class="p">)</span>
            <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;hm0&quot;</span> 
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Wave height&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;These are Hm0 wave heights.&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;xyz_tile_layer&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;max_native_zoom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>
            
            <span class="n">tms</span> <span class="o">=</span> <span class="p">[]</span>            
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">pth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathstr</span><span class="p">):</span>
                <span class="n">tm</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tm</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pth</span>
                <span class="n">tm</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namestr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                <span class="n">tms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>

            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">tms</span>  

            <span class="n">contour_set</span> <span class="o">=</span> <span class="s2">&quot;Hm0&quot;</span>    
            
            <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">contour_set</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>    
            
            <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>

            <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>

            <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>                
            <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>    
                <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
    
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>

                
    <span class="k">def</span> <span class="nf">copy_sederomap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy available sedimentation/erosion map tiles to webviewer folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Copying sedimentation/erosion map tiles ...&quot;</span><span class="p">)</span>
        
        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
             
        <span class="c1"># Check if sedero maps are available</span>
        <span class="n">sedero_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">cycle_tiles_path</span><span class="p">,</span>
                                      <span class="s2">&quot;sedero&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sedero_path</span><span class="p">):</span>

            <span class="n">wvpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">sedero_path</span><span class="p">,</span> <span class="n">wvpath</span><span class="p">)</span>
            <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;sedero&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Sedimentation/erosion&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;This is a sedimentation/erosion map. It can tell if your house will wash away.&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;xyz_tile_layer&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;max_native_zoom&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">16</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>

            <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sedero&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>    
            
            <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>

            <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>

            <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
    
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>


        <span class="c1"># Markers for XBeach models that ran</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wgs84</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;xbeach&quot;</span><span class="p">:</span>
                
                <span class="c1"># Use wave nesting point to put the marker</span>
                <span class="n">xp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">wave_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span>
                <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">wave_boundary_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>            
                <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">wgs84</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">)</span>
                
                <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))</span>
                
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                        <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                    <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">long_name</span><span class="p">,</span>
                                                    <span class="s2">&quot;flow_nested&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">flow_nested_name</span><span class="p">,</span>
                                                    <span class="s2">&quot;wave_nested&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">wave_nested_name</span><span class="p">}))</span>
                        
        <span class="c1"># Save xbeach geojson file</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">stations_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span>
                                    <span class="s2">&quot;xbeach.geojson.js&quot;</span><span class="p">)</span>
            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">stations_file</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var xb_markers =&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">make_meteo_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make wind and precipitation tiles for webviewer.</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="kn">from</span> <span class="nn">cht.misc</span> <span class="kn">import</span> <span class="n">xmlkit</span> <span class="k">as</span> <span class="n">xml</span>

        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Making meteo map tiles ...&quot;</span><span class="p">)</span>

        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Wind</span>
        <span class="n">xml_obj</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">xml2obj</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xml_obj</span><span class="p">,</span> <span class="s2">&quot;meteo_dataset&quot;</span><span class="p">):</span>
            <span class="n">meteo_dataset</span> <span class="o">=</span> <span class="n">xml_obj</span><span class="o">.</span><span class="n">meteo_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

            <span class="k">for</span> <span class="n">meteo_subset</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">meteo_subset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">meteo_dataset</span> <span class="o">==</span> <span class="n">meteo_subset</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    
                    <span class="c1"># TODO these ranges </span>
                    <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">55.0</span><span class="p">]</span>
                    <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">meteo_subset</span><span class="o">.</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                            
                        <span class="n">subset</span> <span class="o">=</span> <span class="n">meteo_subset</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span>
                                                    <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span>
                                                    <span class="n">time_range</span><span class="o">=</span><span class="p">[],</span>
                                                    <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="c1"># Get maximum wind speed</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">quantity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">quantity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span>
                        <span class="n">vmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">wndmx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vmag</span><span class="p">)</span>
                        
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span> <span class="s2">&quot;wind.json.js&quot;</span><span class="p">)</span>
                        <span class="n">subset</span><span class="o">.</span><span class="n">write_wind_to_json</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        
                        <span class="c1"># Add wind to map variables</span>
        
                        <span class="k">if</span> <span class="n">wndmx</span><span class="o">&lt;=</span><span class="mf">20.0</span><span class="p">:</span>
                            <span class="n">contour_set</span> <span class="o">=</span> <span class="s2">&quot;wnd20&quot;</span>
                            <span class="n">wndmx</span><span class="o">=</span><span class="mf">20.0</span>                
                        <span class="k">elif</span> <span class="n">wndmx</span><span class="o">&lt;=</span><span class="mf">40.0</span><span class="p">:</span>   
                            <span class="n">contour_set</span> <span class="o">=</span> <span class="s2">&quot;wnd40&quot;</span>
                            <span class="n">wndmx</span><span class="o">=</span><span class="mf">40.0</span>                
                        <span class="k">else</span><span class="p">:</span>   
                            <span class="n">contour_set</span> <span class="o">=</span> <span class="s2">&quot;wnd60&quot;</span>
                            <span class="n">wndmx</span><span class="o">=</span><span class="mf">60.0</span>                
                
                        <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;wind&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Wind&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;This is a wind map. It can tell if your house will blow away.&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;vector_field&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">wndmx</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>
            
                        <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">contour_set</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>    
                        
                        <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                            
                        <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>
            
                        <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
                        
                        <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>    
                            <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                            <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                            <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                
                        <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
                        
                        <span class="c1"># Cyclone track(s)</span>

                        <span class="c1"># subset = meteo_subset.subset(time_range=[],</span>
                        <span class="c1">#                              stride=1,</span>
                        <span class="c1">#                              tstride=tstride)</span>
        
                        <span class="n">tracks</span> <span class="o">=</span> <span class="n">meteo_subset</span><span class="o">.</span><span class="n">find_cyclone_tracks</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">110.0</span><span class="p">,</span><span class="o">-</span><span class="mf">30.0</span><span class="p">],</span>
                                                                <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">],</span>
                                                                <span class="n">pcyc</span><span class="o">=</span><span class="mf">99500.0</span><span class="p">,</span>
                                                                <span class="n">dt</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">tracks</span><span class="p">:</span>
                            <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
                                
                                <span class="n">points</span><span class="o">=</span><span class="p">[]</span>
                            
                                <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">lon</span><span class="p">)):</span>
                                    <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">track</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="n">track</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">ip</span><span class="p">]))</span>               
                                    <span class="k">if</span> <span class="n">track</span><span class="o">.</span><span class="n">vmax</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">64.0</span><span class="p">:</span>
                                        <span class="n">cat</span> <span class="o">=</span> <span class="s2">&quot;TS&quot;</span>
                                    <span class="k">elif</span> <span class="n">track</span><span class="o">.</span><span class="n">vmax</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">83.0</span><span class="p">:</span>
                                        <span class="n">cat</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
                                    <span class="k">elif</span> <span class="n">track</span><span class="o">.</span><span class="n">vmax</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">96.0</span><span class="p">:</span>    
                                        <span class="n">cat</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
                                    <span class="k">elif</span> <span class="n">track</span><span class="o">.</span><span class="n">vmax</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">113.0</span><span class="p">:</span>    
                                        <span class="n">cat</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>
                                    <span class="k">elif</span> <span class="n">track</span><span class="o">.</span><span class="n">vmax</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">137.0</span><span class="p">:</span>    
                                        <span class="n">cat</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
                                    <span class="k">else</span><span class="p">:</span>    
                                        <span class="n">cat</span> <span class="o">=</span> <span class="s2">&quot;5&quot;</span>
                                    <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                            <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">track</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; UTC&quot;</span><span class="p">,</span>
                                                                        <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="n">track</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                                        <span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="n">track</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                                        <span class="s2">&quot;vmax&quot;</span><span class="p">:</span><span class="n">track</span><span class="o">.</span><span class="n">vmax</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                                        <span class="s2">&quot;pc&quot;</span><span class="p">:</span><span class="n">track</span><span class="o">.</span><span class="n">pc</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                                        <span class="s2">&quot;category&quot;</span><span class="p">:</span><span class="n">cat</span><span class="p">}))</span>
                                    
                                    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">track</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="n">track</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">ip</span><span class="p">]])</span>
                                
                                <span class="n">trk</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="n">points</span><span class="p">)</span>
                                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">trk</span><span class="p">,</span>
                                                        <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;No name&quot;</span><span class="p">}))</span>
                            
                            <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span> <span class="s2">&quot;track.geojson.js&quot;</span><span class="p">)</span>
                            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                                            <span class="n">feature_collection</span><span class="p">,</span>
                                                            <span class="s2">&quot;var track_data =&quot;</span><span class="p">)</span>

        <span class="c1"># Spiderweb tracks</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xml_obj</span><span class="p">,</span> <span class="s2">&quot;meteo_spiderweb&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">track_ensemble</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cht.tropical_cyclone.tropical_cyclone</span> <span class="kn">import</span> <span class="n">to_geojson</span>
            <span class="k">if</span>  <span class="nb">hasattr</span><span class="p">(</span><span class="n">xml_obj</span><span class="p">,</span> <span class="s2">&quot;meteo_spiderweb&quot;</span><span class="p">):</span>
                <span class="n">spwfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span>
                                                <span class="s2">&quot;meteo&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;spiderwebs&quot;</span><span class="p">,</span>
                                                <span class="n">xml_obj</span><span class="o">.</span><span class="n">meteo_spiderweb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">cycfile</span> <span class="o">=</span> <span class="n">spwfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.cyc&#39;</span>
            <span class="k">elif</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">track_ensemble</span><span class="p">:</span>
                <span class="n">cycfile</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span>
                                        <span class="s2">&quot;meteo&quot;</span><span class="p">,</span>
                                        <span class="n">xml_obj</span><span class="o">.</span><span class="n">track_ensemble</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="s2">&quot;*.cyc&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span> <span class="s2">&quot;track.geojson.js&quot;</span><span class="p">)</span>
                <span class="n">to_geojson</span><span class="p">(</span><span class="n">cycfile</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


        <span class="c1"># Ensemble tracks</span>
        <span class="k">if</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">track_ensemble</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

            <span class="n">shpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">main_path</span><span class="p">,</span>
                                            <span class="s2">&quot;meteo&quot;</span><span class="p">,</span>
                                             <span class="n">xml_obj</span><span class="o">.</span><span class="n">track_ensemble</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                             <span class="s1">&#39;ensemble_members&#39;</span><span class="p">,</span> <span class="s1">&#39;ensemble_members.shp&#39;</span><span class="p">)</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shpfile</span><span class="p">)</span>

            <span class="c1"># Convert to GeoJSON</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span> <span class="s2">&quot;ensemble.geojson.js&quot;</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GeoJSON&#39;</span><span class="p">)</span>

            <span class="n">modified_content</span> <span class="o">=</span> <span class="s1">&#39;var track_ens = </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">modified_content</span><span class="p">)</span>

            <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;track_ensemble&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Track ensemble&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;This the track ensemble.&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>         <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ensemble&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>


        <span class="c1"># Cumulative rainfall</span>
        
<span class="c1">#         # Rainfall map for the entire simulation</span>
<span class="c1">#         dt1 = datetime.timedelta(hours=1)</span>
<span class="c1"># #        dt6 = datetime.timedelta(hours=6)</span>
<span class="c1">#         dt24 = datetime.timedelta(hours=24)</span>
<span class="c1">#         t0 = cosmos.cycle_time.replace(tzinfo=None)    </span>
<span class="c1">#         t1 = cosmos.stop_time</span>
        
<span class="c1">#         # First determine max precip for all simulations </span>
<span class="c1">#         pmx = 0.0</span>
<span class="c1">#         okay  = False</span>
<span class="c1">#         for model in cosmos.scenario.model:</span>
<span class="c1">#             if model.type==&quot;sfincs&quot;:</span>
<span class="c1">#                 index_path = os.path.join(model.path, &quot;tiling&quot;, &quot;indices&quot;)</span>
<span class="c1"># #                if model.make_precip_map and os.path.exists(index_path):            </span>
<span class="c1">#                 if os.path.exists(index_path):            </span>
<span class="c1">#                     file_name = os.path.join(model.cycle_output_path, &quot;sfincs_map.nc&quot;)</span>
<span class="c1">#                     # p0max = model.domain.read_cumulative_precipitation(file_name=file_name,</span>
<span class="c1">#                     #                                                    time_range=[t0 + dt1, t1 + dt1])</span>
<span class="c1">#                     # pmx = max(pmx, np.nanmax(p0max))</span>
<span class="c1">#                     okay = True</span>

<span class="c1">#         if okay:</span>

<span class="c1">#             cosmos.log(&quot;Making precipitation tiles ...&quot;)                </span>
                
<span class="c1">#             print(&quot;Maximum precipitation : &quot; + &#39;%6.2f&#39;%pmx + &quot; mm&quot;)                         </span>

<span class="c1">#             contour_set = &quot;precip_log&quot;    </span>

<span class="c1">#             pathstr = []</span>
<span class="c1">#             namestr = []</span>
            
<span class="c1">#             # 24-hour increments</span>
<span class="c1">#             requested_times = pd.date_range(start=t0 + dt24,</span>
<span class="c1">#                                             end=t1,</span>
<span class="c1">#                                             freq=&#39;24H&#39;).to_pydatetime().tolist()</span>

<span class="c1">#             for it, t in enumerate(requested_times):</span>
<span class="c1">#                 pathstr.append((t - dt24).strftime(&quot;%Y%m%d_%HZ&quot;) + &quot;_&quot; + (t).strftime(&quot;%Y%m%d_%HZ&quot;))</span>
<span class="c1">#                 namestr.append((t - dt24).strftime(&quot;%Y-%m-%d %H:%M&quot;) + &quot; - &quot; + (t).strftime(&quot;%Y-%m-%d %H:%M&quot;) + &quot; UTC&quot;)</span>

<span class="c1">#             pathstr.append(&quot;combined_&quot; + (t0).strftime(&quot;%Y%m%d_%HZ&quot;) + &quot;_&quot; + (t1).strftime(&quot;%Y%m%d_%HZ&quot;))</span>
<span class="c1">#             td = t1 - t0</span>
<span class="c1">#             hrstr = str(int(td.days * 24 + td.seconds/3600))</span>
<span class="c1">#             namestr.append(&quot;Combined &quot; + hrstr + &quot;-hour forecast&quot;)</span>

<span class="c1">#             for model in cosmos.scenario.model:</span>
<span class="c1">#                 if model.type==&quot;sfincs&quot; and model.meteo_precipitation:</span>
<span class="c1">#                     index_path = os.path.join(model.path, &quot;tiling&quot;, &quot;indices&quot;)            </span>
<span class="c1"># #                    if model.make_wave_map and os.path.exists(index_path):                            </span>
<span class="c1">#                     if os.path.exists(index_path):                            </span>
                        
<span class="c1">#                         cosmos.log(&quot;Making precip tiles for model &quot; + model.long_name + &quot; ...&quot;)                </span>
    
<span class="c1">#                         file_name = os.path.join(model.cycle_output_path, &quot;sfincs_map.nc&quot;)</span>
                        
<span class="c1">#                         # Precip map over 24-hour increments                    </span>
<span class="c1">#                         for it, t in enumerate(requested_times):</span>
<span class="c1">#                             p = model.domain.read_cumulative_precipitation(file_name=file_name,</span>
<span class="c1">#                                                                            time_range=[t - dt24 + dt1, t + dt1])                        </span>
<span class="c1">#                             p_map_path = os.path.join(cosmos.scenario.cycle_tiles_path,</span>
<span class="c1">#                                                         &quot;precipitation&quot;,</span>
<span class="c1">#                                                         pathstr[it])                        </span>
<span class="c1">#                             make_precipitation_tiles(p, index_path, p_map_path, contour_set)</span>


<span class="c1">#                         # Full simulation       </span>
<span class="c1">#                         p_map_path = os.path.join(cosmos.scenario.cycle_tiles_path,</span>
<span class="c1">#                                                   &quot;precipitation&quot;,</span>
<span class="c1">#                                                    pathstr[-1])                        </span>
<span class="c1">#                         p = model.domain.read_cumulative_precipitation(file_name=file_name,</span>
<span class="c1">#                                                                        time_range=[t0 + dt1, t1 + dt1])                        </span>
<span class="c1">#                         make_precipitation_tiles(p, index_path, p_map_path, contour_set)</span>
            
<span class="c1">#             # Check if wave maps are available</span>
<span class="c1">#             p_map_path = os.path.join(cosmos.scenario.cycle_tiles_path,</span>
<span class="c1">#                                           &quot;precipitation&quot;)</span>
            
<span class="c1">#             ppath = os.path.join(scenario_path)</span>
<span class="c1">#             fo.copy_file(p_map_path, ppath)</span>
<span class="c1">#             dct={}</span>
<span class="c1">#             dct[&quot;name&quot;]        = &quot;precipitation&quot; </span>
<span class="c1">#             dct[&quot;long_name&quot;]   = &quot;Cumulative rainfall&quot;</span>
<span class="c1">#             dct[&quot;description&quot;] = &quot;These are cumulative precipitations.&quot;</span>
<span class="c1">#             dct[&quot;format&quot;]      = &quot;xyz_tile_layer&quot;</span>
<span class="c1">#             dct[&quot;max_native_zoom&quot;]  = 10</span>
            
<span class="c1">#             tms = []            </span>
<span class="c1">#             for it, pth in enumerate(pathstr):</span>
<span class="c1">#                 tm = {}</span>
<span class="c1">#                 tm[&quot;name&quot;]   = pth</span>
<span class="c1">#                 tm[&quot;string&quot;] = namestr[it]</span>
<span class="c1">#                 tms.append(tm)</span>

<span class="c1">#             dct[&quot;times&quot;]        = tms  </span>
            
<span class="c1">#             mp = next((x for x in cosmos.config.map_contours if x[&quot;name&quot;] == contour_set), None)    </span>
            
<span class="c1">#             lgn = {}</span>
<span class="c1">#             lgn[&quot;text&quot;] = mp[&quot;string&quot;]</span>

<span class="c1">#             cntrs = mp[&quot;contours&quot;]</span>

<span class="c1">#             contours = []</span>
            
<span class="c1">#             for cntr in cntrs:</span>
<span class="c1">#                 contour = {}</span>
<span class="c1">#                 contour[&quot;text&quot;]  = cntr[&quot;string&quot;]</span>
<span class="c1">#                 contour[&quot;color&quot;] = &quot;#&quot; + cntr[&quot;hex&quot;]</span>
<span class="c1">#                 contours.append(contour)</span>
    
<span class="c1">#             lgn[&quot;contours&quot;] = contours</span>
<span class="c1">#             dct[&quot;legend&quot;]   = lgn</span>
            
<span class="c1">#             self.map_variables.append(dct)</span>

    <span class="k">def</span> <span class="nf">copy_bedlevelmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy available bedlevel map tiles to webviewer folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Copying bed level map tiles ...&quot;</span><span class="p">)</span>
        
        <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
             
        <span class="c1"># Check if sedero maps are available</span>
        <span class="n">zb0_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">cycle_tiles_path</span><span class="p">,</span>
                                      <span class="s2">&quot;zb0&quot;</span><span class="p">)</span>
        <span class="n">zbend_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">cycle_tiles_path</span><span class="p">,</span>
                              <span class="s2">&quot;zbend&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zb0_path</span><span class="p">):</span>

            <span class="n">wvpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">zb0_path</span><span class="p">,</span> <span class="n">wvpath</span><span class="p">)</span>
            <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;zb0&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Pre-storm bed level&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;These were the bed levels prior to the storm&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;xyz_tile_layer&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>

            <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bed_levels&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>    
            
            <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>

            <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>

            <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>    
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
            
            <span class="c1"># for icntr,cntr in enumerate(cntrs):</span>
            <span class="c1">#     if icntr in np.arange(0, 101,10):</span>
            <span class="c1">#         contour = {}</span>
            <span class="c1">#         contour[&quot;text&quot;]  = cntr[&quot;string&quot;]</span>
            <span class="c1">#         contour[&quot;color&quot;] = &quot;#&quot; + cntr[&quot;hex&quot;]</span>
            <span class="c1">#         contours.append(contour)</span>
        
            <span class="c1">#         lgn[&quot;contours&quot;] = contours</span>
            <span class="c1">#         dct[&quot;legend&quot;]   = lgn</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         continue</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zbend_path</span><span class="p">):</span>

            <span class="n">wvpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">zbend_path</span><span class="p">,</span> <span class="n">wvpath</span><span class="p">)</span>
            <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;zbend&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Post-storm bed level&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;These are the predicted bed levels after the storm&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;xyz_tile_layer&quot;</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>

            <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bed_levels&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>    
            
            <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>

            <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>

            <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>    
            <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>


            <span class="c1"># cntrs = mp[&quot;contours&quot;]</span>

            <span class="c1"># contours = []</span>
            
            <span class="c1"># for icntr,cntr in enumerate(cntrs):</span>
            <span class="c1">#     if icntr in np.arange(0, 101,10):</span>
            <span class="c1">#         contour = {}</span>
            <span class="c1">#         contour[&quot;text&quot;]  = cntr[&quot;string&quot;]</span>
            <span class="c1">#         contour[&quot;color&quot;] = &quot;#&quot; + cntr[&quot;hex&quot;]</span>
            <span class="c1">#         contours.append(contour)</span>
        
            <span class="c1">#         lgn[&quot;contours&quot;] = contours</span>
            <span class="c1">#         dct[&quot;legend&quot;]   = lgn</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         continue</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
            

    <span class="k">def</span> <span class="nf">make_runup_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;Make runup markers and timeseries for webviewer.</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                     <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                     <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Extreme runup height</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beware&#39;</span><span class="p">:</span>
                
                <span class="k">try</span><span class="p">:</span>

                    <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cycle_output_path</span><span class="p">,</span>
                                                        <span class="s2">&quot;beware_his.nc&quot;</span><span class="p">))</span>                
    
                    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                                       <span class="s1">&#39;WGS 84&#39;</span><span class="p">,</span>
                                                       <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">)):</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">xp</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                     <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">yp</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Loc nr: &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                                    
                        <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,:])</span>                                                                       
                        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;LocNr&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">]),</span>
                                                            <span class="s2">&quot;Lon&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span>
                                                            <span class="s2">&quot;Lat&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span>                                                
                                                            <span class="s2">&quot;Setup&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                            <span class="s2">&quot;Swash&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">swash</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                            <span class="s2">&quot;TWL&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">)}))</span>
                    
                    <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                        <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                        <span class="n">output_path_runup</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;extreme_runup_height</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">fo</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path_runup</span><span class="p">)</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path_runup</span><span class="p">,</span>
                                                <span class="s2">&quot;extreme_runup_height.geojson.js&quot;</span><span class="p">)</span>
                        <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var runup =&quot;</span><span class="p">)</span>
    
                    <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;extreme_runup_height&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Maximum Total Water Level (best track)&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;These are the predicted total water levels&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;twl&quot;</span>
    
    
                    <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;run_up&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>                    
     
                    <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
        
                    <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>
        
                    <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                        <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                        <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                        <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            
                    <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
    
        
                    <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
    
                    <span class="c1"># Probabilistic runup</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cycle_output_path</span><span class="p">,</span>
                                                            <span class="s2">&quot;beware_his_ensemble.nc&quot;</span><span class="p">)):</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cycle_output_path</span><span class="p">,</span>
                                                            <span class="s2">&quot;beware_his_ensemble.nc&quot;</span><span class="p">),</span> <span class="n">prcs</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>                
        
                        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                                        <span class="s1">&#39;WGS 84&#39;</span><span class="p">,</span>
                                                        <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">)):</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">xp</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                        <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">yp</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                            <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Loc nr: &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                                        
                            <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,:])</span>                                                                       
                            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                    <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                <span class="s2">&quot;LocNr&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">]),</span>
                                                                <span class="s2">&quot;Lon&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span>
                                                                <span class="s2">&quot;Lat&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span>                                                
                                                                <span class="s2">&quot;Setup&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup_prc</span><span class="p">[</span><span class="s2">&quot;95&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                                <span class="s2">&quot;Swash&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">swash</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                                <span class="s2">&quot;TWL&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p_prc</span><span class="p">[</span><span class="s2">&quot;95&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">)}))</span>
                        
                        <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                            <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                            <span class="n">output_path_runup</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;extreme_runup_height_prc95</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">fo</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path_runup</span><span class="p">)</span>
                            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path_runup</span><span class="p">,</span>
                                                    <span class="s2">&quot;extreme_runup_height_prc95.geojson.js&quot;</span><span class="p">)</span>
                            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var runup_prc95 =&quot;</span><span class="p">)</span>
        
                        <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;extreme_runup_height_prc95&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Maximum Total Water Level (95 </span><span class="si">% o</span><span class="s2">f ensemble)&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;These are the predicted extreme run-up heights&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;twl&quot;</span>
        
                        <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;run_up&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>                    
        
                        <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
            
                        <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>
            
                        <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
                        
                        <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                            <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                            <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                            <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
                
                        <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
                        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>
        
            
                        <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>

                    <span class="c1"># Horizontal runup</span>

                    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="n">dfx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;runup.x&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;runup.y&#39;</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                    
                    <span class="n">r2max</span><span class="o">=</span> <span class="n">dfx</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>

                    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">)):</span>
                       
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Loc nr: &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                                    
                        <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,:])</span>   

                        <span class="n">id2</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">r2max</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="nb">id</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dfx</span><span class="p">[</span><span class="n">r2max</span><span class="p">[</span><span class="n">id2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">dfy</span><span class="p">[</span><span class="n">r2max</span><span class="p">[</span><span class="n">id2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

                        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                 <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;LocNr&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">]),</span>
                                                            <span class="s2">&quot;Lon&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span>
                                                            <span class="s2">&quot;Lat&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span>                                                
                                                            <span class="s2">&quot;Setup&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                            <span class="s2">&quot;Swash&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">swash</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                            <span class="s2">&quot;TWL&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">)}))</span>
                    <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                        <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                        <span class="n">output_path_runup</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;extreme_horizontal_runup_height</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path_runup</span><span class="p">)</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path_runup</span><span class="p">,</span>     
                                                <span class="s2">&quot;extreme_horizontal_runup_height.geojson.js&quot;</span><span class="p">)</span>
                        <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var runup_vert =&quot;</span><span class="p">)</span>


                    <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;extreme_horizontal_runup_height&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Horizontal extent of Total Water Level&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;This is the extreme horizontal runup.&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;twl&quot;</span>
                    <span class="c1"># dct[&quot;legend&quot;]      = {&quot;text&quot;: &quot;Offshore WL&quot;, &quot;contours&quot;: [{&quot;text&quot;: &quot; 0.0&amp;nbsp-&amp;nbsp;0.33&amp;#8201;m&quot;, &quot;color&quot;: &quot;#CCFFFF&quot;}, {&quot;text&quot;: &quot; 0.33&amp;nbsp;-&amp;nbsp;1.0&amp;#8201;m&quot;, &quot;color&quot;: &quot;#40E0D0&quot;}, {&quot;text&quot;: &quot; 1.0&amp;nbsp-&amp;nbsp;2.0&amp;#8201;m&quot;, &quot;color&quot;: &quot;#00BFFF&quot;}, {&quot;text&quot;: &quot;&amp;gt; 2.0&amp;#8201;m&quot;, &quot;color&quot;: &quot;#0909FF&quot;}]}</span>
                    
                    <span class="n">mp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">map_contours</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;run_up&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>                    
     
                    <span class="n">lgn</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
        
                    <span class="n">cntrs</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span>
        
                    <span class="n">contours</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">for</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="n">cntrs</span><span class="p">:</span>
                        <span class="n">contour</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span>
                        <span class="n">contour</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">cntr</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]</span>
                        <span class="n">contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
            
                    <span class="n">lgn</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contours</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lgn</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>                


                    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                        
                    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">)):</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">xo</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                                     <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">yo</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Loc nr: &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                                    
                        <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,:])</span>                                                               
                        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">point</span><span class="p">,</span>
                                                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="s2">&quot;LocNr&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">]),</span>
                                                            <span class="s2">&quot;Lon&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                                            <span class="s2">&quot;Lat&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                                            <span class="s2">&quot;Hs&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                                                            <span class="s2">&quot;Tp&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Tp</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span>
                                                            <span class="s2">&quot;WL&quot;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">WL</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="nb">id</span><span class="p">],</span><span class="mi">2</span><span class="p">)}))</span>
                    <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                        <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                        <span class="n">output_path_waves</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;extreme_sea_level_and_wave_height</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path_waves</span><span class="p">)</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path_waves</span><span class="p">,</span>     
                                                <span class="s2">&quot;extreme_sea_level_and_wave_height.geojson.js&quot;</span><span class="p">)</span>
                        <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">feature_collection</span><span class="p">,</span> <span class="s2">&quot;var swl =&quot;</span><span class="p">)</span>


                    <span class="n">dct</span><span class="o">=</span><span class="p">{}</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;extreme_sea_level_and_wave_height&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Offshore WL and Hs&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;This is the total offshore water level (tide + surge) and wave conditions.&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;geojson&quot;</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Offshore WL&quot;</span><span class="p">,</span> <span class="s2">&quot;contours&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot; 0.0&amp;nbsp-&amp;nbsp;0.33&amp;#8201;m&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#CCFFFF&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot; 0.33&amp;nbsp;-&amp;nbsp;1.0&amp;#8201;m&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#40E0D0&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot; 1.0&amp;nbsp-&amp;nbsp;2.0&amp;#8201;m&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#00BFFF&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;&amp;gt; 2.0&amp;#8201;m&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#0909FF&quot;</span><span class="p">}]}</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;infographic&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;empty&quot;</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">map_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
                

                    <span class="c1"># Time series </span>
                        
                    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">)):</span>
                        
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cycle_output_path</span><span class="p">,</span>
                                                            <span class="s2">&quot;beware_his_ensemble.nc&quot;</span><span class="p">)):</span>  
                            <span class="n">d</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WL&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">WL</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span><span class="s1">&#39;Setup&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span> <span class="s1">&#39;Swash&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">swash</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span> <span class="s1">&#39;Runup&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span>
                                <span class="s1">&#39;Setup_5&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup_prc</span><span class="p">[</span><span class="s2">&quot;5&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,:],</span><span class="s1">&#39;Setup_50&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup_prc</span><span class="p">[</span><span class="s2">&quot;50&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,:],</span><span class="s1">&#39;Setup_95&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup_prc</span><span class="p">[</span><span class="s2">&quot;95&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,:],</span>
                                <span class="s1">&#39;Runup_5&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p_prc</span><span class="p">[</span><span class="s2">&quot;5&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,:],</span><span class="s1">&#39;Runup_50&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p_prc</span><span class="p">[</span><span class="s2">&quot;50&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,:],</span><span class="s1">&#39;Runup_95&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p_prc</span><span class="p">[</span><span class="s2">&quot;95&quot;</span><span class="p">][</span><span class="n">ip</span><span class="p">,:],}</span>       
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WL&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">WL</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span><span class="s1">&#39;Setup&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">setup</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span> <span class="s1">&#39;Swash&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">swash</span><span class="p">[</span><span class="n">ip</span><span class="p">,:],</span> <span class="s1">&#39;Runup&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">R2p</span><span class="p">[</span><span class="n">ip</span><span class="p">,:]}</span>       
            
                        <span class="n">v</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">tstart</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">swash</span><span class="p">[</span><span class="n">ip</span><span class="p">,:]),</span> <span class="n">freq</span><span class="o">=</span> <span class="s1">&#39;0.5H&#39;</span><span class="p">))</span>
                        <span class="n">obs_file</span> <span class="o">=</span> <span class="s2">&quot;extreme_runup_height.&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">runid</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.csv.js&quot;</span>
            
                        <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span>  <span class="s2">&quot;timeseries&quot;</span><span class="p">,</span>
                                                           <span class="n">obs_file</span><span class="p">)</span>
                        <span class="n">s</span><span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">,</span>
                                     <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span>
                                     <span class="n">header</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span> <span class="s1">&#39;datetime&#39;</span><span class="p">)</span> 
                               
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cycle_output_path</span><span class="p">,</span> <span class="s2">&quot;beware_his_ensemble.nc&quot;</span><span class="p">)):</span>
                            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_csv_js</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;var csv = `date_time,wl,setup,swash,runup, setup_5, setup_50, setup_95, runup_5, runup_50, runup_95&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_csv_js</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;var csv = `date_time,wl,setup,swash,runup&quot;</span><span class="p">)</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;An error occurred when making BEWARE webviewer !&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;Upload local webviewer to server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">cht.misc.sftp</span> <span class="kn">import</span> <span class="n">SSHSession</span>
        
        <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Uploading web viewer ...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Upload entire copy of local web viewer to web server</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">SSHSession</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ftp_hostname</span><span class="p">,</span>
                           <span class="n">username</span><span class="o">=</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ftp_username</span><span class="p">,</span>
                           <span class="n">password</span><span class="o">=</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ftp_password</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Error! Could not connect to sftp server !&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            
            <span class="c1"># Check if web viewer already exist</span>
            <span class="n">make_wv_on_ftp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="c1"># Web viewer does not even exist locally</span>
                <span class="n">make_wv_on_ftp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if web viewer exists on FTP</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ftp_path</span><span class="p">):</span>
                    <span class="n">make_wv_on_ftp</span> <span class="o">=</span> <span class="kc">True</span>
                    
            <span class="k">if</span> <span class="n">make_wv_on_ftp</span><span class="p">:</span>
                <span class="c1"># Copy entire webviewer</span>
                <span class="n">f</span><span class="o">.</span><span class="n">put_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ftp_path</span><span class="p">)</span>
    
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Webviewer already on ftp server</span>
                
                <span class="c1"># Only copy scenario output</span>
                <span class="n">scenario_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                             <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                                             <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">remote_path</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ftp_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/data&quot;</span>
                <span class="c1"># Check if scenario is already on ftp server</span>
                <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Removing existing data on web server ...&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">remote_path</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">remote_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    
                <span class="c1"># Copy scenarios.js    </span>
                <span class="n">remote_file</span> <span class="o">=</span> <span class="n">remote_path</span> <span class="o">+</span> <span class="s2">&quot;/scenarios.js&quot;</span>
                <span class="n">local_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;scenarios.js&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
                <span class="n">update_scenarios_js</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>                
                <span class="c1"># Copy new scenarios.js to server</span>
                <span class="n">f</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_path</span> <span class="o">+</span> <span class="s2">&quot;/scenarios.js&quot;</span><span class="p">)</span>
                <span class="c1"># Delete local scenarios.js</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>

                <span class="c1"># Copy scenario data to server</span>
                <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Uploading all data to web server ...&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">put_all</span><span class="p">(</span><span class="n">scenario_path</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    
            <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Done uploading.&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;An error occurred while uploading !&quot;</span><span class="p">)</span>
            <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">upload_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="c1"># Upload data from local web viewer to web server</span>
        <span class="k">pass</span></div>

<span class="k">def</span> <span class="nf">update_scenarios_js</span><span class="p">(</span><span class="n">sc_file</span><span class="p">):</span>
    
    <span class="c1"># Check if there is a scenarios.js file</span>
    <span class="c1"># If so, append it with the current scenario</span>
    <span class="n">isame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">cosmos</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Updating scenario file : &quot;</span> <span class="o">+</span> <span class="n">sc_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fo</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sc_file</span><span class="p">):</span>
        <span class="n">scs</span> <span class="o">=</span> <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">read_json_js</span><span class="p">(</span><span class="n">sc_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isc</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">isame</span> <span class="o">=</span> <span class="n">isc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Current scenario        </span>
    <span class="n">newsc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span>    
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">long_name</span>    
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">description</span>    
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">lon</span>    
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">lat</span>
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">zoom</span>    
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;cycle&quot;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">cosmos</span><span class="o">.</span><span class="n">cycle_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cosmos</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">run_duration</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">newsc</span><span class="p">[</span><span class="s2">&quot;last_update&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span> <span class="o">+</span> <span class="s2">&quot; (UTC)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">isame</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Scenario already existed in web viewer</span>
        <span class="n">scs</span><span class="p">[</span><span class="n">isame</span><span class="p">]</span> <span class="o">=</span> <span class="n">newsc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># New scenario in web viewer    </span>
        <span class="n">scs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newsc</span><span class="p">)</span>        

    <span class="n">cht</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">write_json_js</span><span class="p">(</span><span class="n">sc_file</span><span class="p">,</span> <span class="n">scs</span><span class="p">,</span> <span class="s2">&quot;var scenario =&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Deltares.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>